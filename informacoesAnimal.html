<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Animal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .details-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }

        .animal-image {
            flex: 1;
            max-width: 350px;
        }

        .animal-image img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .animal-details {
            flex: 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .animal-details p {
            margin: 5px 0;
            font-size: 16px;
            line-height: 1.5;
        }

        .ong-details {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .ong-details h2 {
            margin-top: 0;
            font-size: 18px;
        }

        .ong-details p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <div id="alertaSucesso" class="alert alert-success d-none" role="alert"></div>
    Animal adicionado com sucesso!
    </div>
    <div id="alertaErro" class="alert alert-danger d-none" role="alert">
        Revise as informações do animal
    </div>
    
    <div class="container">
        <h1>Detalhes do Animal</h1>
        <div class="details-container">
            <div class="animal-image">
                <img id="imagemAnimal" src="" alt="Imagem do Animal" />
            </div>
            <form id="updateAnimalForm">
                <div class="mb-3">
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="imagem2" accept="image/*">
                        <label class="custom-file-label" for="imagem2">IMAGEM</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="modal-nome" class="form-label">Nome</label>
                    <input type="text" class="form-control" name="nome2" id="nome2" placeholder="NOME" required>
                </div>
                <div class="mb-3">
                    <label for="modal-email" class="form-label">Peso</label>
                    <input type="text" class="form-control" name="peso2" id="peso2" placeholder="PESO (Kg)" required>
                </div>
                <div class="mb-3">
                    <label for="modal-data-nascimento" class="form-label">Data de Nascimento</label>
                    <input type="date" class="form-control date" name="dataNascimento2" id="dataNascimento2"
                        placeholder="DATA DE NASCIMENTO" required>
                </div>
                <div class="mb-3">
                    <label for="modal-sexo" class="form-label">Sexo</label>
                    <select class="form-control" id="sexo2">
                        <option value="" disabled selected>SEXO</option>
                        <option value="M">MACHO</option>
                        <option value="F">FÊMEA</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modal-raca" class="form-label">Raça</label>
                    <select class="form-control" id="racaSelect2">
                        <option value="" disabled selected>RAÇA</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modal-especie" class="form-label">Espécie</label>
                    <select class="form-control" id="especieSelect2">
                        <option value="" disabled selected>ESPECIE</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modal-pelagem" class="form-label">Pelagem</label>
                    <select class="form-control" id="pelagemSelect2">
                        <option value="" disabled selected>PELAGEM</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modal-porte" class="form-label">Porte</label>
                    <select class="form-control" id="porteSelect2">
                        <option value="" disabled selected>PORTE</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modal-status" class="form-label">Status</label>
                    <select name="" id="statusAnimalSelect2" class="form-control">
                        <option value="" disabled selected>STATUS</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modal-complemento" class="form-label">Descrição</label>
                    <textarea name="descricao2" id="descricao2" placeholder="PORQUE NGM ME ADOTA"></textarea>
                </div>
                <button type="button" class="btn btn-primary" onclick="atualizarAnimal()">Salvar mudanças</button>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            var token = window.localStorage.getItem('token');
            var animalId = window.localStorage.getItem('animalId');
            console.log("Token e ID do Animal lidos do localStorage:", token, animalId);

            if (!token || !animalId) {
                console.error('Token ou ID do Animal não encontrados no localStorage.');
                return;
            }

            populateSelectRaca();
            populateSelectEspecie();
            populateSelectPelagem();
            populateSelectPorte();
            populateSelectStatusAnimal();

            $.ajax({
                url: `http://localhost:8080/animal/lista/${animalId}`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token // Adiciona o token no cabeçalho da requisição
                },
                success: function (data) {
                    // Preencher os detalhes do animal
                    $('#imagemAnimal').attr('src', window.location.origin + data.imagem);
                    $('#nome2').val(data.nome);
                    $('#peso2').val(data.peso);
                    $('#dataNascimento2').val(data.dataNascimento);
                    $('#sexo2').val(data.sexo);
                    $('#racaSelect2').val(data.racaAnimal.id);
                    $('#especieSelect2').val(data.especieAnimal.id);
                    $('#pelagemSelect2').val(data.pelagemAnimal.id);
                    $('#porteSelect2').val(data.porteAnimal.id);
                    $('#statusAnimalSelect2').val(data.statusAnimal.id);
                    $('#descricao2').val(data.descricao);

                    // Opcional: Preencher os detalhes da ONG se necessário
                    if (data.ongModel) {
                        $('#ongRazaoSocial').text(data.ongModel.razaosocial);
                        $('#ongEmail').text(data.ongModel.email);
                        $('#ongCnpj').text(data.ongModel.cnpj);
                        $('#ongTelefone').text(data.ongModel.telefone);
                        $('#ongEndereco').text(`${data.ongModel.logradouro}, ${data.ongModel.numero}, ${data.ongModel.bairro}, ${data.ongModel.cidade} - ${data.ongModel.estado}, ${data.ongModel.cep}`);
                    }
                },
                error: function (error) {
                    console.error('Erro ao buscar detalhes do animal:', error);
                }
            });
        });

        function populateSelectRaca() {
            const select2 = document.getElementById("racaSelect2");

            fetch('http://localhost:8080/raca/get')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const option2 = document.createElement("option");
                            option2.value = item.id;
                            option2.text = item.tipo;
                            select2.appendChild(option2);
                        });
                    } else {
                        console.error('O formato dos dados da raça está incorreto.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar as raças:', error);
                });
        }

        function populateSelectEspecie() {
            const select2 = document.getElementById("especieSelect2");

            fetch('http://localhost:8080/especie/get')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const option2 = document.createElement("option");
                            option2.value = item.id;
                            option2.text = item.tipo;
                            select2.appendChild(option2);
                        });
                    } else {
                        console.error('O formato dos dados da espécie está incorreto.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar as espécies:', error);
                });
        }

        function populateSelectPelagem() {
            const select2 = document.getElementById("pelagemSelect2");

            fetch('http://localhost:8080/pelagem/get')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const option2 = document.createElement("option");
                            option2.value = item.id;
                            option2.text = item.tipo;
                            select2.appendChild(option2);
                        });
                    } else {
                        console.error('O formato dos dados da pelagem está incorreto.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar as pelagens:', error);
                });
        }

        function populateSelectPorte() {
            const select2 = document.getElementById("porteSelect2");

            fetch('http://localhost:8080/porte/get')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const option2 = document.createElement("option");
                            option2.value = item.id;
                            option2.text = item.tipo;
                            select2.appendChild(option2);
                        });
                    } else {
                        console.error('O formato dos dados do porte está incorreto.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar os portes:', error);
                });
        }

        function populateSelectStatusAnimal() {
            const select2 = document.getElementById("statusAnimalSelect2");

            fetch('http://localhost:8080/statusAnimal/get')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const option2 = document.createElement("option");
                            option2.value = item.id;
                            option2.text = item.tipo;
                            select2.appendChild(option2);
                        });
                    } else {
                        console.error('O formato dos dados do status animal está incorreto.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar os status dos animais:', error);
                });
        }

        function atualizarAnimal() {
            var token = window.localStorage.getItem('token');
            var animalId = window.localStorage.getItem('animalId'); // Pega o ID do animal armazenado no localStorage
            var nome = $('#nome2').val();
            var peso = parseFloat($('#peso2').val());
            var dataNascimento = $('#dataNascimento2').val();
            var sexo = $('#sexo2').val();
            var racaAnimal = parseInt($('#racaSelect2').val());
            var especieAnimal = parseInt($('#especieSelect2').val());
            var pelagemAnimal = parseInt($('#pelagemSelect2').val());
            var porteAnimal = parseInt($('#porteSelect2').val());
            var statusAnimal = parseInt($('#statusAnimalSelect2').val());
            var descricao = $('#descricao2').val();
            var imagem = $('#imagem2')[0].files[0];

            if (!nome || !peso || !dataNascimento || !sexo || !racaAnimal || !especieAnimal || !pelagemAnimal || !porteAnimal || !imagem || !descricao || !statusAnimal) {
                mostrarAlertaErro('Você deve preencher todas as informações solicitadas no formulário.');
                return;
            }

            // Cria o objeto FormData e adiciona os campos
            var formData = new FormData();
            formData.append('animal', new Blob([JSON.stringify({
                nome: nome,
                peso: peso,
                dataNascimento: dataNascimento,
                sexo: sexo,
                racaAnimal: { id: racaAnimal },
                especieAnimal: { id: especieAnimal },
                pelagemAnimal: { id: pelagemAnimal },
                porteAnimal: { id: porteAnimal },
                statusAnimal: { id: statusAnimal },
                descricao: descricao
            })], { type: "application/json" }));
            formData.append('file', imagem);

            console.log("Dados enviados: ", formData);

            $.ajax({
                url: `http://localhost:8080/animal/edit/${animalId}`, // Usando o ID correto do animal
                type: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token // Adiciona o token no cabeçalho da requisição
                },
                data: formData,
                processData: false, // Não processa o FormData automaticamente
                contentType: false, // Define o tipo de conteúdo como multipart/form-data
                success: function (data) {
                    console.log('Formulário enviado com sucesso', data);
                    mostrarAlertaSucesso();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Erro ao enviar formulário:', jqXHR, textStatus, errorThrown);
                    mostrarAlertaErro('Erro ao enviar formulário. Tente novamente.');
                }
            });
        }

        function mostrarAlertaSucesso() {
            $('#alertaSucesso').removeClass('d-none');
            setTimeout(function () {
                $('#alertaSucesso').addClass('d-none');
            }, 3000);
        }

        function mostrarAlertaErro(message) {
            $('#alertaErro').text(message).removeClass('d-none');
            setTimeout(function () {
                $('#alertaErro').addClass('d-none');
            }, 3000);
        }
    </script>
</body>

</html>